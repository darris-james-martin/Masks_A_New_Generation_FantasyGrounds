<?xml version="1.0" encoding="iso-8859-1"?>
<root>
  <windowclass name="combattracker_client">
    <frame>ctbox</frame>
    <placement>
      <size height="400" width="523" />
    </placement>
    <nodelete />
    <softclose />
    <sizelimits resize="both">
      <minimum width="400" height="400" />
      <dynamic />
    </sizelimits>
    <script>
function onInit()
    OptionsManager.registerCallback("CTSI", updateShowOrder);
    updateShowOrder();
end

function onClose()
    OptionsManager.unregisterCallback("CTSI", updateShowOrder);
end

function updateShowOrder()
    local bShowInit = not OptionsManager.isOption("CTSI", "off");
    label_init.setVisible(bShowInit);
end

</script>
    <sheetdata>
      <windowtitlebar name="title">
        <resource>Window_combattracker_client_Title</resource>
      </windowtitlebar>
      <stringcontrol name="label_name">
        <bounds>31,39,-137,20</bounds>
        <center />
        <color>#FFFFFFFF</color>
        <static textres="combattracker_client_label_name_LabelCaption" />
        <font>sheetlabel</font>
        <readonly />
      </stringcontrol>
      <stringcontrol name="label_init">
        <bounds>-129,39,39,20</bounds>
        <color>#FFFFFFFF</color>
        <static textres="combattracker_client_label_init_LabelCaption" />
        <font>sheetlabel</font>
        <readonly />
      </stringcontrol>
      <windowlist name="list">
        <bounds>0,68,-18,-54</bounds>
        <class>client_ct_entry</class>
        <datasource>.list</datasource>
        <empty></empty>
        <script>
function onInit()
	Interface.onHotkeyActivated = onHotkey;
	
	local node = getDatabaseNode();
	DB.addHandler(DB.getPath(node, "*.name"), "onUpdate", onNameUpdated);
	DB.addHandler(DB.getPath(node, "*.nonid_name"), "onUpdate", onNameUpdated);
	DB.addHandler(DB.getPath(node, "*.isidentified"), "onUpdate", onNameUpdated);

	OptionsManager.registerCallback("CTSI", onOptionCTSIChanged);
end

function onClose()
	local node = getDatabaseNode();
	DB.removeHandler(DB.getPath(node, "*.name"), "onUpdate", onNameUpdated);
	DB.removeHandler(DB.getPath(node, "*.nonid_name"), "onUpdate", onNameUpdated);
	DB.removeHandler(DB.getPath(node, "*.isidentified"), "onUpdate", onNameUpdated);

	OptionsManager.unregisterCallback("CTSI", onOptionCTSIChanged);
end

function onNameUpdated(vNode)
	for _,w in pairs(getWindows()) do
		w.target_summary.onTargetsChanged();
	end
end

function onOptionCTSIChanged()
	for _,v in pairs(getWindows()) do
		v.updateDisplay();
	end
	applySort();
end

function onSortCompare(w1, w2)
	return CombatManager.onSortCompare(w1.getDatabaseNode(), w2.getDatabaseNode());
end

function onHotkey(draginfo)
	local sDragType = draginfo.getType();
	if sDragType == "combattrackernextactor" then
		CombatManager.notifyEndTurn();
		return true;
	end
end

function onFilter(w)
	if w.friendfoe.getStringValue() == "friend" then
		return true;
	end
	if w.tokenvis.getValue() ~= 0 then
		return true;
	end
	return false;
end

function onDrop(x, y, draginfo)
	local w = getWindowAt(x,y);
	if w then
		local nodeWin = w.getDatabaseNode();
		if nodeWin then
			return CombatManager.onDrop("ct", nodeWin.getPath(), draginfo);
		end
	end
end

function onClickDown(button, x, y)
	if Input.isControlPressed() then
		return true;
	end
end

function onClickRelease(button, x, y)
	if Input.isControlPressed() then
		local w = getWindowAt(x, y);
		if w then
			TargetingManager.toggleClientCTTarget(w.getDatabaseNode());
		end

		return true;
	end
end

</script>
      </windowlist>
      <scrollbarcontrol name="scrollbar_list">
        <frame>
          <name>scrollbar_base</name>
          <offset>0,12,0,12</offset>
        </frame>
        <bounds>-26,76,20,-66</bounds>
        <target>list</target>
        <normal name="scrollbutton_normal">
          <minimum height="scrollbutton_normal" />
        </normal>
      </scrollbarcontrol>
      <buttoncontrol name="turn_complete">
        <bounds>29,-46,33,26</bounds>
        <invisible />
        <tooltip textres="combattracker_client_turn_complete_Tooltip" />
        <icon normal="button_ctnextactor" pressed="button_ctnextactor_down" />
        <font>button-white</font>
        <script>
function onButtonPress()
    CombatManager.notifyEndTurn();
end

function onDragStart(button, x, y, draginfo)
    draginfo.setType("combattrackernextactor");
    draginfo.setIcon("button_ctnextactor");
    
    return true;
end
</script>
      </buttoncontrol>
      <stringcontrol name="label_ct_host_rounds">
        <bounds>-117,-42,39,20</bounds>
        <color>#FFFFFFFF</color>
        <static textres="combattracker_client_label_ct_host_rounds_LabelCaption" />
        <font>sheetlabel</font>
        <readonly />
      </stringcontrol>
      <simplenumber name="round">
        <frame>
          <name>ct_groupbox</name>
          <offset>3,3,3,3</offset>
        </frame>
        <bounds>-71,-42,44,19</bounds>
        <readonly />
      </simplenumber>
      <genericcontrol name="resize_ctbox">
        <bounds>-25,-24,18,18</bounds>
        <icon>window_resize</icon>
      </genericcontrol>
      <help_base name="button_helper">
        <bounds>-70,8,24,24</bounds>
        <icon normal="button_help" />
        <font>button-white</font>
        <urlres>help_tool_ct</urlres>
      </help_base>
      <close_base name="button_close">
        <bounds>-46,8,24,24</bounds>
        <icon normal="button_close" />
        <font>button-white</font>
      </close_base>
    </sheetdata>
  </windowclass>
</root>